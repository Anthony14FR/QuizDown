{% extends 'base.html.twig' %}

{% block body %}
    <div class="container mx-auto p-4 max-w-4xl">
        {{ form_start(form) }}
        <div class="card bg-base-100 shadow p-6 mb-6">
            {{ form_row(form.title, {'attr': {'class': 'input input-bordered w-full'}}) }}
            {{ form_row(form.description, {'attr': {'class': 'textarea textarea-bordered w-full'}}) }}
            {{ form_row(form.defaultScore, {'attr': {'class': 'input input-bordered w-full'}}) }}
        </div>

        <div class="questions-wrapper" data-index="{{ form.questions|length }}">
            <h2 class="text-xl font-bold mb-4">Questions</h2>
            <div id="questions">
                {% for questionForm in form.questions %}
                    <div class="question-item card bg-base-200 p-6 mb-4">
                        {{ form_row(questionForm.type) }}
                        {{ form_row(questionForm.content) }}
                        {{ form_row(questionForm.difficulty) }}
                        <div class="answers-collection">
                            {% for answerForm in questionForm.answers %}
                                <div class="answer-item">
                                    {{ form_row(answerForm.content) }}
                                    {{ form_row(answerForm.isCorrect) }}
                                </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary mt-2 add-answer">Ajouter une réponse</button>
                        <button type="button" class="btn btn-error mt-4" onclick="this.closest('.question-item').remove()">Supprimer</button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" class="btn btn-primary mt-4" onclick="addQuestion()">Ajouter une question</button>
        </div>

        <button type="submit" class="btn btn-success mt-6">Sauvegarder</button>
        {{ form_end(form) }}
    </div>

    <script>
        let questionIndex = {{ form.questions|length }};

        function addQuestion() {
            const questions = document.getElementById('questions');
            const prototype = `
        <div class="question-item card bg-base-200 p-6 mb-4">
            <select name="quiz[questions][${questionIndex}][type]" class="select select-bordered w-full mb-4" required>
                <option value="single_choice">Choix unique</option>
                <option value="true_false">Vrai/Faux</option>
                <option value="multiple_choice">Choix multiple</option>
            </select>
            <input type="text" name="quiz[questions][${questionIndex}][content]" class="input input-bordered w-full mb-4" placeholder="Question">
            <input type="number" name="quiz[questions][${questionIndex}][difficulty]" class="input input-bordered w-full mb-4" value="1" min="1" max="5">
            <div class="answers-collection"></div>
            <button type="button" class="btn btn-sm btn-secondary mt-2 add-answer">Ajouter une réponse</button>
            <button type="button" class="btn btn-error mt-4" onclick="this.closest('.question-item').remove()">Supprimer</button>
        </div>
    `;

            questions.insertAdjacentHTML('beforeend', prototype);

            const newQuestion = questions.lastElementChild;
            initializeQuestionEvents(newQuestion);

            questionIndex++;
        }

        function addAnswer(questionDiv) {
            const answersDiv = questionDiv.querySelector('.answers-collection');
            const answerCount = answersDiv.children.length;
            const type = questionDiv.querySelector('select').value;
            const questionId = questionDiv.dataset.questionIndex || questionIndex;

            const prototype = `
        <div class="answer-item bg-base-100 p-3 rounded-lg mb-2">
            <input type="text" name="quiz[questions][${questionId}][answers][${answerCount}][content]" class="input input-bordered w-full mb-2" placeholder="Réponse">
            <label class="flex items-center gap-2">
                <input type="${type === 'multiple_choice' ? 'checkbox' : 'radio'}"
                       name="quiz[questions][${questionId}][answers][${answerCount}][isCorrect]"
                       class="checkbox">
                <span>Réponse correcte</span>
            </label>
            <button type="button" class="btn btn-error btn-sm mt-2" onclick="this.closest('.answer-item').remove()">Supprimer</button>
        </div>
    `;

            answersDiv.insertAdjacentHTML('beforeend', prototype);
        }

        function initializeQuestionEvents(questionDiv) {
            const typeSelect = questionDiv.querySelector('select');
            const addAnswerBtn = questionDiv.querySelector('.add-answer');

            typeSelect.addEventListener('change', (e) => {
                const answersCollection = questionDiv.querySelector('.answers-collection');
                answersCollection.innerHTML = '';

                if (e.target.value === 'true_false') {
                    addAnswer(questionDiv);
                    addAnswer(questionDiv);
                    const answers = questionDiv.querySelectorAll('.answer-item input[type="text"]');
                    answers[0].value = 'Vrai';
                    answers[1].value = 'Faux';
                    addAnswerBtn.style.display = 'none';
                } else {
                    addAnswerBtn.style.display = 'block';
                }
            });

            addAnswerBtn.addEventListener('click', () => addAnswer(questionDiv));
        }

        document.querySelectorAll('.question-item').forEach(initializeQuestionEvents);
    </script>
{% endblock %}
